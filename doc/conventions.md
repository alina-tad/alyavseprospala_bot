# Правила разработки кода

> **Основа:** См. @vision.md для полного технического видения проекта

## Основные принципы

### KISS (Keep It Simple, Stupid)
- Минимум зависимостей
- Простой, читаемый код
- Только необходимый функционал

### MVP-first подход
- Базовый функционал → улучшения
- Короткие циклы разработки
- Быстрое тестирование

## Структура кода

- Создавай файлы согласно структуре из @vision.md.
- Не создавай дополнительные директории без необходимости.
- Используй относительные импорты внутри проекта.

### Модульность
- Независимые компоненты: Bot | LLM | Data
- Четкое разделение ответственности
- Легкое тестирование

### Архитектура
```
Пользователь → Telegram Bot → LLM Client → OpenRouter
                ↓
            Data Manager → JSON файлы
```

## Зависимости

- Все зависимости фиксируй в файле `pyproject.toml` для управления через `uv`.
- Избегай сторонних библиотек, если функционал можно реализовать стандартными средствами.

## Работа с LLM

- Следуй подходу по работе с LLM из @vision.md.
- Сохраняй историю диалогов в JSON.
- Всегда включай системный промпт в запросы к LLM.

## Стиль кода

### Python
- Python 3.11+
- Type hints для функций
- Docstrings для публичных методов
- PEP 8 для форматирования
- Используй "говорящие" имена.
- Добавляй краткие комментарии для неочевидных решений.
- Пиши асинхронный код с использованием async/await.

### Именование
- `snake_case` для переменных и функций
- `UPPER_CASE` для констант
- `PascalCase` для классов
- Описательные имена

## Конфигурация

### Переменные окружения
- Все настройки в `.env`
- API ключи, параметры LLM, системные промпты
- Никаких хардкодов

### Структура данных
```python
# Пользователь
{
  "user_id": "123456789",
  "username": "user_name", 
  "created_at": "2024-01-01T00:00:00Z",
  "settings": {}
}

# Диалог
{
  "session_id": "uuid",
  "user_id": "123456789",
  "messages": [
    {"role": "system", "content": "промпт", "timestamp": "..."},
    {"role": "user", "content": "текст", "timestamp": "..."},
    {"role": "assistant", "content": "ответ", "timestamp": "..."}
  ],
  "created_at": "2024-01-01T00:00:00Z"
}
```

## Обработка ошибок

- Используй простую обработку исключений без сложных иерархий.

### LLM интеграция
- Retry логика для API запросов
- Graceful fallback при ошибках
- Логирование всех запросов

### Telegram Bot
- Обработка всех типов сообщений
- Информативные сообщения об ошибках
- Graceful shutdown

## Логирование

### Уровни
- **INFO** - основные операции
- **WARNING** - потенциальные проблемы  
- **ERROR** - критические ошибки

### Структура
- JSON формат логов
- Временные метки
- Контекст операции

## Тестирование

- Писать тесты только для критически важного функционала.
- Использовать `pytest` для тестирования.
- Все внешние зависимости мокать.

### Структура
```
tests/
├── test_bot.py      # Тесты Telegram бота
├── test_llm.py      # Тесты LLM интеграции
└── test_data.py     # Тесты работы с данными
```

## Деплой

### Docker
- Легковесный образ
- Минимум слоев
- Безопасные переменные окружения

### Зависимости
- `uv` для управления пакетами
- Фиксированные версии
- Минимум внешних зависимостей

## Расширяемость

### Добавление функций
- Модульная архитектура
- Конфигурируемые компоненты
- Обратная совместимость

### Изменения
- Версионирование API
- Миграции данных
- Документирование изменений 